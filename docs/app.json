[{"name":"app.R","content":"library(shiny)\nlibrary(ggplot2)\nlibrary(data.table)\n\n# Define the UI\nui <- fluidPage(\n  titlePanel(\"PGS Portability App\"),\n  sidebarLayout(\n    sidebarPanel(\n      selectInput(\"ancestry\", \"Target Ancestry:\",\n                  choices = c(\"African\", \"Caribbean\", \"East Asian\", \"South Asian\")\n      ),\n      br(),\n      radioButtons(\"input_range\", \"Marker Input:\",\n                   choices = c(\"Range of Markers (within chromosome)\",\n                               \"Comma-separated List of SNP RS IDs\", \"Single Gene\", \"Single Marker\")\n      ),\n      br(),\n      conditionalPanel(\n        condition = \"input.input_range == 'Single Marker'\",\n        radioButtons(\"input_type\", \"Input Type:\",\n                     choices = c(\"Base Pair Position & Chromosome\", \"SNP RS ID\")\n        )\n      ),\n      conditionalPanel(\n        condition = \"input.input_range == 'Range of Markers (within chromosome)'\",\n        radioButtons(\"input_type2\", \"Input Type:\",\n                     choices = c(\"Base Pair Position & Chromosome\", \"SNP RS ID\")\n        )\n      ),\n      conditionalPanel(\n        condition = \"input.input_type == 'SNP RS ID' && input.input_range == 'Single Marker'\",\n        textInput(\"rs_id\", \"Enter SNP ID (e.g., rs4422948):\",\n                  value = \"rs4422948\")\n      ),\n      conditionalPanel(\n        condition = \"input.input_type == 'Base Pair Position & Chromosome' && \n              input.input_range == 'Single Marker'\",\n        numericInput(\"chromosome_input\", \"Enter Chromosome:\", value = 1),\n        numericInput(\"bp_position\", \"Enter Base Pair Position (in bp):\", value = 835499)\n      ),\n      conditionalPanel(\n        condition = \"input.input_type2 == 'SNP RS ID' && input.input_range == \n              'Range of Markers (within chromosome)'\",\n        textInput(\"start_snp_id\", \"Enter Start SNP ID:\",\n                  value = \"rs35062161\"),\n        textInput(\"end_snp_id\", \"Enter End SNP ID:\",\n                  value = \"rs2074468\")\n      ),\n      conditionalPanel(\n        condition = \"input.input_type2 == 'Base Pair Position & Chromosome' && \n              input.input_range == 'Range of Markers (within chromosome)'\",\n        numericInput(\"chromosome_input2\", \"Enter Chromosome:\", value = 6),\n        numericInput(\"start_bp_position\", \"Enter Start Base Pair Position in Mbp (e.g., part of the MHC region):\",\n                     value = 29.75),\n        numericInput(\"end_bp_position\", \"Enter End Base Pair Position in Mbp:\",\n                     value = 30.5)\n      ),\n      conditionalPanel(\n        condition = \"input.input_range == 'Comma-separated List of SNP RS IDs'\",\n        textInput(\"snp_list\", \"Enter SNP List (e.g., rs4422948,rs6686302):\",\n                  value = c(\"rs4422948,rs6686302\"))\n      ),\n      conditionalPanel(\n        condition = \"input.input_range == 'Single Gene'\",\n        textInput(\"gene_name\", \"Enter Gene Name (e.g., ABCG2):\",\n                  value = \"ABCG2\")\n      ),\n      br(),br(),br(),br(),br(),br(),br(),br(),br(),\n      radioButtons(\"dataset.input\", \"SNP Set (Note, the HapMap set is not recommended.):\",\n                   choices = c(\"UK Biobank Arrays\", \"HapMap Variants\")\n      ),\n    ),\n    mainPanel(\n      fluidRow(width = 10,\n               column(10,\n                      htmlOutput(\"error_message\")\n               )\n      ),\n      fluidRow(width = 10,\n               column(10,\n                      verbatimTextOutput(\"error_message2\")\n               )\n      ),\n      fluidRow(width = 9, \n               h3(\"Table 1:\"),\n               h5(\"The PGS portability estimates averaged across the selected input SNPs (relative \n                  accuracy, cross-ancestry R-squared [EU to target ancestry], and within-ancestry \n                  R-squared [EU to EU]).\"),\n               tableOutput(\"table1\")\n      ),\n      fluidRow(width = 10, \n               plotOutput(\"histogram\"),\n               h3(\"Figure 1:\"),\n               h5(\"Relative accuracy distribution. The genome-wide relative accuracy distribution is in blue \n           for the selected target ancestry group. The relative accuracy distribution for the subset \n           of selected variants is shown in purple. The number of variants entering into the subset \n           (if applicable) is noted in the upper-right corner. The x-axis with the HapMap variants \n           has been capped at a RA of 4 for plotting purposes.\")\n      ),\n      fluidRow(width = 9, \n               h3(\"Table 2:\"),\n               h5(\"Relative accuracy map for each of the selected variants and target ancestry group. \n                  Each row is a SNP and the columns contain SNP information (rsID, chromosome, \n                  base pair position, reference allele), PGS portability measures (relative \n                  accuracy, cross-ancestry R-squared [EU to target ancestry], and within-ancestry \n                  R-squared [EU to EU]), corresponding SEs and MC error for each portability measure, \n                  and the annotated gene name if available.\"),\n               downloadButton(\"download_table\", \"Download Table\"),\n               tableOutput(\"table2\")\n      )\n    )\n  )\n)\n\n# Define the server\nserver <- function(input, output, session) {\n  \n  dat <- reactive({\n    if(input$dataset.input == \"UK Biobank Arrays\"){\n      dat <- fread(\"https://media.githubusercontent.com/media/lupiA/MCANOVA/main/csv_files/MAP_UKB.csv\",data.table=F)\n    } else{\n      dat <- fread(\"https://media.githubusercontent.com/media/lupiA/MCANOVA/main/csv_files/MAP_HAPMAP.csv\",data.table=F)\n    }\n  })\n  \n  ancestry_label <- reactive({\n    if(input$ancestry == \"African\"){\n      \"AF\"\n    } else if(input$ancestry == \"Caribbean\"){\n      \"CR\"\n    } else if(input$ancestry == \"East Asian\"){\n      \"EA\"\n    } else if(input$ancestry == \"South Asian\"){\n      \"SA\"\n    }\n  })\n  \n  start_bp_input <- reactive({\n    if(input$input_type2 == 'Base Pair Position & Chromosome' && input$input_range == 'Range of Markers (within chromosome)'){\n      input$start_bp_position * 1e6\n    }\n  })\n  \n  end_bp_input <- reactive({\n    if(input$input_type2 == 'Base Pair Position & Chromosome' && input$input_range == 'Range of Markers (within chromosome)'){\n      input$end_bp_position * 1e6\n    }\n  })\n  \n  filtered_snp_data <- reactive({\n    snps <- dat()\n    snps <- snps[snps$Cohort == input$ancestry, ]\n    if(input$ancestry %in% c(\"African\", \"East Asian\")){\n      snps <- snps[-(which(is.na(snps[,7]))), ]\n    }\n    colnames(snps)[6:15] <- c(\"Relative Accuracy\", \n                              paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                              \"Rsq. EU\\u2192EU\", \n                              \"MC Error RA\", \n                              \"S.E. RA\", \n                              paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                              paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                              \"MC Error Rsq. EU\\u2192EU\",\n                              \"S.E. Rsq. EU\\u2192EU\",\n                              \"Target Ancestry\")\n    \n    snp_data <- NULL\n    \n    if (input$input_range == \"Single Marker\") {\n      \n      if (input$input_type == \"SNP RS ID\") {\n        snp_data <- snps[which(snps$SNP == input$rs_id),\n                         c(\"Target Ancestry\", \"SNP\",\"Relative Accuracy\", paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                           \"Rsq. EU\\u2192EU\", \"Chromosome\", \"BP position\", \"Allele\", \"Gene\",\n                           \"MC Error RA\", \n                           \"S.E. RA\", \n                           paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                           paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                           \"MC Error Rsq. EU\\u2192EU\",\n                           \"S.E. Rsq. EU\\u2192EU\")]\n      } \n      \n      else if (input$input_type == \"Base Pair Position & Chromosome\") {\n        snps_chr <- snps[which(snps$Chromosome == input$chromosome_input),]\n        if(length(which(snps_chr$`BP position` == input$bp_position))>0){\n          snp_data <- snps_chr[which(snps_chr$`BP position` == input$bp_position),\n                               c(\"Target Ancestry\", \"SNP\",\"Relative Accuracy\", paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                                 \"Rsq. EU\\u2192EU\", \"Chromosome\", \"BP position\", \"Allele\", \"Gene\",\n                                 \"MC Error RA\", \n                                 \"S.E. RA\", \n                                 paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                                 paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                                 \"MC Error Rsq. EU\\u2192EU\",\n                                 \"S.E. Rsq. EU\\u2192EU\")]\n        } else {\n          lb <- max(which(snps_chr$`BP position` <= input$bp_position))\n          ub <- min(which(snps_chr$`BP position` >= input$bp_position))\n          \n          if(length(lb) == 1 & length(ub) == 1){\n            tmp_data <- snps_chr[lb:ub,\n                                 c(\"Target Ancestry\", \"SNP\",\"Relative Accuracy\", paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                                   \"Rsq. EU\\u2192EU\", \"Chromosome\", \"BP position\", \"Allele\", \"Gene\",\n                                   \"MC Error RA\", \n                                   \"S.E. RA\", \n                                   paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                                   paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                                   \"MC Error Rsq. EU\\u2192EU\",\n                                   \"S.E. Rsq. EU\\u2192EU\")]\n            snp_data <- tmp_data[1,]\n            snp_data[, \"SNP\"] <- paste0(tmp_data[1, \"SNP\"], \"; \", tmp_data[2, \"SNP\"])\n            snp_data[, \"Allele\"] <- paste0(tmp_data[1, \"Allele\"], \"; \", tmp_data[2, \"Allele\"])\n            snp_data[, \"BP position\"] <- paste0(tmp_data[1, \"BP position\"], \"; \", tmp_data[2, \"BP position\"])\n            snp_data[, \"Gene\"] <- paste0(tmp_data[1, \"Gene\"], \"; \", tmp_data[2, \"Gene\"])\n            \n            snp_data[, \"Relative Accuracy\"] <- mean(tmp_data[, \"Relative Accuracy\"],na.rm=T)\n            snp_data[, paste0(\"Rsq. EU\\u2192\", ancestry_label())] <- mean(tmp_data[, paste0(\"Rsq. EU\\u2192\", ancestry_label())],na.rm=T)\n            snp_data[, \"Rsq. EU\\u2192EU\"] <- mean(tmp_data[, \"Rsq. EU\\u2192EU\"],na.rm=T)\n            \n            snp_data[, \"S.E. RA\"] <- mean(tmp_data[, \"S.E. RA\"],na.rm=T)\n            snp_data[, paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label())] <- mean(tmp_data[, paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label())],na.rm=T)\n            snp_data[, \"S.E. Rsq. EU\\u2192EU\"] <- mean(tmp_data[, \"S.E. Rsq. EU\\u2192EU\"],na.rm=T)\n            snp_data[, \"MC Error RA\"] <- mean(tmp_data[, \"MC Error RA\"],na.rm=T)\n            snp_data[, paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label())] <- mean(tmp_data[, paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label())],na.rm=T)\n            snp_data[, \"MC Error Rsq. EU\\u2192EU\"] <- mean(tmp_data[, \"MC Error Rsq. EU\\u2192EU\"],na.rm=T)\n          }\n          \n        }        \n        \n      }\n      \n    }  else if (input$input_range == \"Range of Markers (within chromosome)\") {\n      \n      if (input$input_type2 == \"SNP RS ID\") {\n        start_snp_idx_1 <- which(snps$SNP == input$start_snp_id)\n        end_snp_idx_1 <- which(snps$SNP == input$end_snp_id)\n        \n        if (length(start_snp_idx_1) > 0 && length(end_snp_idx_1) > 0 &&\n            snps$Chromosome[start_snp_idx_1] == snps$Chromosome[end_snp_idx_1]) {\n          snp_data <- snps[start_snp_idx_1:end_snp_idx_1,\n                           c(\"Target Ancestry\", \"SNP\",\"Relative Accuracy\", paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                             \"Rsq. EU\\u2192EU\", \"Chromosome\", \"BP position\", \"Allele\", \"Gene\",\n                             \"MC Error RA\", \n                             \"S.E. RA\", \n                             paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                             paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                             \"MC Error Rsq. EU\\u2192EU\",\n                             \"S.E. Rsq. EU\\u2192EU\")]\n          \n        }\n        \n      }  else if (input$input_type2 == \"Base Pair Position & Chromosome\") {\n        snps <- snps[which(snps$Chromosome == input$chromosome_input2), ]\n        \n        if(is.null(start_bp_input()) || is.null(end_bp_input()) || is.na(start_bp_input()) || is.na(end_bp_input())){\n          snp_data <- NULL\n        } else if(length(start_bp_input():end_bp_input()) > 0 && start_bp_input() < end_bp_input() && \n                  start_bp_input() > 0 && nrow(snps)>0){\n          snp_data <- snps[which(snps$`BP position` %in% start_bp_input():end_bp_input()),\n                           c(\"Target Ancestry\", \"SNP\",\"Relative Accuracy\", paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                             \"Rsq. EU\\u2192EU\", \"Chromosome\", \"BP position\", \"Allele\", \"Gene\",\n                             \"MC Error RA\", \n                             \"S.E. RA\", \n                             paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                             paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                             \"MC Error Rsq. EU\\u2192EU\",\n                             \"S.E. Rsq. EU\\u2192EU\")]\n        }\n      }\n    }  else if (input$input_range == \"Comma-separated List of SNP RS IDs\") {\n      snps_in_list <- unlist(strsplit(as.character(input$snp_list), split = \",\"))\n      \n      if (length(snps_in_list) > 0) {\n        snp_data <- snps[which(snps$SNP %in% snps_in_list),\n                         c(\"Target Ancestry\", \"SNP\",\"Relative Accuracy\", paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                           \"Rsq. EU\\u2192EU\", \"Chromosome\", \"BP position\", \"Allele\", \"Gene\",\n                           \"MC Error RA\", \n                           \"S.E. RA\", \n                           paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                           paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                           \"MC Error Rsq. EU\\u2192EU\",\n                           \"S.E. Rsq. EU\\u2192EU\")]\n      }\n      \n    }  else if (input$input_range == \"Single Gene\") {\n      snps_in_list <- snps$SNP[which(snps$Gene == input$gene_name)]\n      \n      if (length(snps_in_list) > 0) {\n        snp_data <- snps[which(snps$SNP %in% snps_in_list),\n                         c(\"Target Ancestry\", \"SNP\",\"Relative Accuracy\", paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                           \"Rsq. EU\\u2192EU\", \"Chromosome\", \"BP position\", \"Allele\", \"Gene\",\n                           \"MC Error RA\", \n                           \"S.E. RA\", \n                           paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                           paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                           \"MC Error Rsq. EU\\u2192EU\",\n                           \"S.E. Rsq. EU\\u2192EU\")]\n      }\n    }\n    \n    if (is.null(snp_data) || nrow(snp_data) == 0) {\n      snp_data <- NULL\n    }\n    snp_data\n  })\n  \n  filtered_hist_data <- reactive({\n    hist <- dat()\n    hist <- hist[hist$Cohort == input$ancestry, ]\n    if(input$ancestry %in% c(\"African\", \"East Asian\")){\n      hist <- hist[-(which(is.na(hist[,7]))), ]\n    }\n    colnames(hist)[6:14] <- c(\"Relative Accuracy\", \n                              paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                              \"Rsq. EU\\u2192EU\", \n                              \"MC Error RA\", \n                              \"S.E. RA\", \n                              paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                              paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                              \"MC Error Rsq. EU\\u2192EU\",\n                              \"S.E. Rsq. EU\\u2192EU\")\n    hist_data <- hist[ , c(\"Relative Accuracy\",\"Cohort\")]\n    if (nrow(hist_data) == 0) {\n      hist_data <- NULL\n    }\n    if (!is.null(hist_data) && length(which(is.na(hist_data$`Relative Accuracy`))) > 0) {\n      hist_data <- hist_data[-which(is.na(hist_data$`Relative Accuracy`)), ]\n    }\n    hist_data\n  })\n  \n  output$table1 <- renderTable({\n    if (!is.null(input$rs_id) && !is.null(input$ancestry) && !is.null(filtered_snp_data())) {\n      if (!is.null(filtered_snp_data())) {\n        averages <- colMeans(filtered_snp_data()[ , c(\"Relative Accuracy\", paste0(\"Rsq. EU\\u2192\", ancestry_label()), \"Rsq. EU\\u2192EU\")], na.rm = TRUE)\n        if (input$input_range == \"Range of Markers (within chromosome)\") {\n          data.frame(\"Metric\" = names(averages), \"Average\" = averages)\n        } else if (input$input_range == \"Single Marker\") {\n          data.frame(\"Metric\" = names(averages), \"Value\" = averages)\n        } else if (input$input_range == \"Comma-separated List of SNP RS IDs\") {\n          data.frame(\"Metric\" = names(averages), \"Average\" = averages)\n        } else if (input$input_range == \"Single Gene\") {\n          data.frame(\"Metric\" = names(averages), \"Average\" = averages)\n        }\n      }\n    }\n  })\n  \n  output$table2 <- renderTable({\n    if (!is.null(input$rs_id) && !is.null(input$ancestry) && !is.null(filtered_snp_data())) {\n      if (!is.null(filtered_snp_data())) {\n        modified_table <- filtered_snp_data()[, c(\"Target Ancestry\", \"SNP\", \"Chromosome\", \"BP position\",  \n                                                  \"Relative Accuracy\", \n                                                  paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                                                  \"Rsq. EU\\u2192EU\",\n                                                  \"MC Error RA\", \n                                                  \"S.E. RA\", \n                                                  paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                                                  paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                                                  \"MC Error Rsq. EU\\u2192EU\",\n                                                  \"S.E. Rsq. EU\\u2192EU\",\n                                                  \"Allele\", \"Gene\")]\n        \n        colnames(modified_table)[3]=\"Chr\"\n        data.frame(modified_table,check.names = FALSE)\n      }\n    }\n  })\n  \n  output$histogram <- renderPlot({\n    if(input$dataset.input == \"UK Biobank Arrays\"){\n      theme.ggplot <- theme(legend.position = \"none\",\n                            axis.text = element_text(size = 17), axis.title = element_text(size=19), strip.text = element_text(size=20),\n                            panel.background = element_rect(fill = \"aliceblue\", colour = \"grey\",\n                                                            linewidth = 2, linetype = \"solid\"), panel.grid.major = element_line(linewidth = 0.5, linetype = 'solid', colour = \"grey\"), \n                            axis.title.y = element_text(vjust=1, margin = margin(t=0, r=5, b=0, l=5)),\n                            axis.title.x = element_text(vjust = -.05,margin = margin(t=10, r=0, b=5, l=0)),\n                            panel.grid.minor = element_line(linewidth = 0.25, linetype = 'solid', colour = \"grey\"),\n                            plot.title = element_blank())\n      if (input$input_range == \"Single Marker\" && !is.null(input$rs_id) && !is.null(input$ancestry) && !is.null(filtered_hist_data())) {\n        ra_values <- as.numeric(filtered_hist_data()$`Relative Accuracy`)\n        snp_ra <- as.numeric(filtered_snp_data()$`Relative Accuracy`)\n        snp_percentile <- ecdf(ra_values)(snp_ra) * 100\n        \n        label_text <- paste0(round(snp_percentile, 2), \"%\")\n        ggplot() +\n          geom_histogram(aes(x = ra_values), fill = \"skyblue\", color = \"midnightblue\", binwidth = 0.03) +\n          geom_vline(xintercept = snp_ra, color = \"white\", linewidth = 1.7) +\n          geom_vline(xintercept = snp_ra, color = \"#2E0854\", linewidth = 1.3) +\n          labs(x = \"Relative Accuracy\", y = \"Frequency\") +\n          annotate(\"text\", x = Inf, y = Inf, hjust = 1.1, vjust = 1.4, \n                   label = paste0(\"Relative Accuracy\\nPercentile: \", label_text, sep = \"\"), \n                   color = \"#2E0854\", size = 6, fontface = 2) +\n          theme.ggplot\n        \n      } else if (input$input_range == \"Range of Markers (within chromosome)\" || input$input_range == \"Comma-separated List of SNP RS IDs\" || \n                 input$input_range == \"Single Gene\" && !is.null(input$ancestry) && !is.null(filtered_hist_data())) {\n        ra_values <- as.numeric(filtered_hist_data()$`Relative Accuracy`)\n        snp_ra <- as.numeric(filtered_snp_data()$`Relative Accuracy`)\n        \n        p1 <- ggplot()\n        if(input$ancestry == \"East Asian\"){\n          y_val = 10000\n        } else{\n          y_val = 20000\n        }\n        if (length(table(snp_ra)) > 10) {\n          p1 +\n            geom_histogram(aes(x = ra_values), fill = \"skyblue\", color = \"midnightblue\", binwidth = 0.03) +\n            geom_violin(aes(x = snp_ra, y = y_val), fill = \"#2E0854\", alpha = .35, color = \"#2E0854\", width = 7500, linewidth = 1.2) +\n            annotate(\"text\", x = Inf, y = Inf, hjust = 1.1, vjust = 1.4,\n                     label = paste0(\"Number of SNPs\\nin Input: \", length(snp_ra), sep=\"\"), color = \"#2E0854\", size = 6, fontface = 2) +\n            labs(x = \"Relative Accuracy\", y = \"Frequency\") +\n            theme.ggplot\n        } else {\n          p1 +\n            geom_histogram(aes(x = ra_values), fill = \"skyblue\", color = \"midnightblue\", binwidth = 0.03) +\n            geom_vline(xintercept = snp_ra, color = \"white\", linewidth = 1.7) +\n            geom_vline(xintercept = snp_ra, color = \"#2E0854\", linewidth = 1.3) +\n            labs(x = \"Relative Accuracy\", y = \"Frequency\") +\n            theme.ggplot\n        }\n      }\n    } else{\n      theme.ggplot <- theme(legend.position = \"none\",\n                            axis.text = element_text(size = 17), axis.title = element_text(size=19), strip.text = element_text(size=20),\n                            panel.background = element_rect(fill = \"aliceblue\", colour = \"grey\",\n                                                            linewidth = 2, linetype = \"solid\"), panel.grid.major = element_line(linewidth = 0.5, linetype = 'solid', colour = \"grey\"), \n                            axis.title.y = element_text(vjust=1, margin = margin(t=0, r=5, b=0, l=5)),\n                            axis.title.x = element_text(vjust = -.05,margin = margin(t=10, r=0, b=5, l=0)),\n                            panel.grid.minor = element_line(linewidth = 0.25, linetype = 'solid', colour = \"grey\"),\n                            plot.title = element_blank())\n      if (input$input_range == \"Single Marker\" && !is.null(input$rs_id) && !is.null(input$ancestry) && !is.null(filtered_hist_data())) {\n        ra_values <- as.numeric(filtered_hist_data()$`Relative Accuracy`)\n        snp_ra <- as.numeric(filtered_snp_data()$`Relative Accuracy`)\n        snp_percentile <- ecdf(ra_values)(snp_ra) * 100\n        \n        label_text <- paste0(round(snp_percentile, 2), \"%\")\n        suppressWarnings(print(ggplot() +\n                                 geom_histogram(aes(x = ra_values), fill = \"skyblue\", color = \"midnightblue\", binwidth = 0.06) +\n                                 geom_vline(xintercept = snp_ra, color = \"white\", linewidth = 1.7) +\n                                 geom_vline(xintercept = snp_ra, color = \"#2E0854\", linewidth = 1.3) +\n                                 labs(x = \"Relative Accuracy\", y = \"Frequency\") +\n                                 xlim(0,4) +\n                                 annotate(\"text\", x = Inf, y = Inf, hjust = 1.1, vjust = 1.4, \n                                          label = paste0(\"Relative Accuracy\\nPercentile: \", label_text, sep = \"\"), \n                                          color = \"#2E0854\", size = 6, fontface = 2) +\n                                 theme.ggplot))\n        \n      } else if (input$input_range == \"Range of Markers (within chromosome)\" || input$input_range == \"Comma-separated List of SNP RS IDs\" || \n                 input$input_range == \"Single Gene\" && !is.null(input$ancestry) && !is.null(filtered_hist_data())) {\n        ra_values <- as.numeric(filtered_hist_data()$`Relative Accuracy`)\n        snp_ra <- as.numeric(filtered_snp_data()$`Relative Accuracy`)\n        \n        p1 <- ggplot()\n        if(input$ancestry == \"East Asian\"){\n          y_val = 200000\n        } else if(input$ancestry == \"South Asian\"){\n          y_val = 400000\n        } else if(input$ancestry == \"African\"){\n          y_val = 75000\n        } else if(input$ancestry == \"Caribbean\"){\n          y_val = 100000\n        }\n        \n        p1 <- ggplot()\n        if (length(table(snp_ra)) > 10) {\n          suppressWarnings(print(p1 +\n                                   geom_histogram(aes(x = ra_values), fill = \"skyblue\", color = \"midnightblue\", binwidth = 0.06) +\n                                   geom_violin(aes(x = snp_ra, y = y_val), fill = \"#2E0854\", alpha = .35, color = \"#2E0854\", width = 7500, linewidth = 1.2) +\n                                   annotate(\"text\", x = Inf, y = Inf, hjust = 1.1, vjust = 1.4,\n                                            label = paste0(\"Number of SNPs\\nin Input: \", length(snp_ra), sep=\"\"), color = \"#2E0854\", size = 6, fontface = 2) +\n                                   labs(x = \"Relative Accuracy\", y = \"Frequency\") +\n                                   xlim(0,4) +\n                                   theme.ggplot))\n        } else {\n          suppressWarnings(print(p1 +\n                                   geom_histogram(aes(x = ra_values), fill = \"skyblue\", color = \"midnightblue\", binwidth = 0.06) +\n                                   geom_vline(xintercept = snp_ra, color = \"white\", linewidth = 1.7) +\n                                   geom_vline(xintercept = snp_ra, color = \"#2E0854\", linewidth = 1.3) +\n                                   labs(x = \"Relative Accuracy\", y = \"Frequency\") +\n                                   xlim(0,4) +\n                                   theme.ggplot))\n        }\n      }\n    }\n  })\n  \n  output$download_table <- downloadHandler(\n    filename = function() {\n      paste(\"table_\", Sys.Date(), \".csv\", sep = \"\")\n    },\n    content = function(file) {\n      if (!is.null(input$rs_id) && !is.null(input$ancestry) && !is.null(filtered_snp_data())) {\n        filtered_table <- filtered_snp_data()[, c(\"Target Ancestry\", \"SNP\", \"Chromosome\", \"BP position\",  \n                                                  \"Relative Accuracy\", \n                                                  paste0(\"Rsq. EU\\u2192\", ancestry_label()), \n                                                  \"Rsq. EU\\u2192EU\",\n                                                  \"MC Error RA\", \n                                                  \"S.E. RA\", \n                                                  paste0(\"MC Error Rsq. EU\\u2192\", ancestry_label()), \n                                                  paste0(\"S.E. Rsq. EU\\u2192\", ancestry_label()), \n                                                  \"MC Error Rsq. EU\\u2192EU\",\n                                                  \"S.E. Rsq. EU\\u2192EU\",\n                                                  \"Allele\", \"Gene\")]\n        data.frame(filtered_table, check.names = FALSE)\n        colnames(filtered_table)[c(1,4,5)] <- c(\"Ancestry\", \"BP_position\", \"RA\")\n        colnames(filtered_table)[6:7] <- c(\"Rsq.across\", \"Rsq.within\")\n        colnames(filtered_table)[8:13] <- c(\"MC_error_RA\", \"SE_RA\",\"MC_error_Rsq.across\",\"SE_Rsq.across\",\"MC_error_Rsq.within\",\"SE_Rsq.within\")\n        write.csv(filtered_table, file, row.names = FALSE)\n      }\n    }\n  )\n  \n  output$error_message <- renderText({\n    filtered_data <- filtered_snp_data()\n    \n    if (is.null(filtered_data)) {\n      return(\n        HTML(paste(\"<div style='white-space: pre-wrap;'><font color=\\\"#EB5406\\\" size=\\\"4\\\"><b>\",\n                   \"Invalid inputs. Note that if an input is monomorphic for the\\n\",\n                   \"selected ancestry group it is not a valid input for that group.\\n\",\n                   \"<\/b><\/font><br><\/div>\")\n        )\n      )\n    } else {\n      return(NULL)\n    }\n  })\n  \n  output$error_message2 <- renderText({\n    \n    filtered_data <- filtered_snp_data()\n    \n    if (is.null(filtered_data)) {\n      \n      if (input$input_range == \"Range of Markers (within chromosome)\" && input$input_type2 == \"SNP RS ID\") {\n        return(\"Error: Note that the range of entries must be within-chromosome\\n\n            and SNP RS IDs must be in the UK Biobank genotyping array\\n\n            (or HapMap if selected) and are case sensitive.\")\n      }\n      \n      if (input$input_range == \"Range of Markers (within chromosome)\" && input$input_type2 == \"Base Pair Position & Chromosome\") {\n        return(\"Error: Note that the range of entries must be within-chromosome\\n\n            and in Mbp units.\")\n      }\n      \n      if (input$input_range == \"Comma-separated List of SNP RS IDs\") {\n        return(\"Error: Note that the comma-separated list of SNP RS IDs should not\\n\n            have any spaces and only valid SNP RS IDs are allowed.\")\n      }\n      \n      if (input$input_range == \"Single Gene\") {\n        return(\"Error: Note that gene name must be annotated in the UK Biobank\\n\n          array (or HapMap if selected) and is case sensitive.\")\n      }\n      \n      if (input$input_range == \"Single Marker\" && input$input_type == \"SNP RS ID\") {\n        return(\"Error: Note that the SNP RS ID must be in the UK Biobank\\n\n          genotyping array and is case sensitive.\")\n      }\n      \n      if (input$input_range == \"Single Marker\" && input$input_type == \"Base Pair Position & Chromosome\") {\n        return(\"Error: Note that a single BP position entry must be within\\n\n          range and in base pair units.\")\n      }\n      \n    } else {\n      return(NULL)\n    }\n  })\n  \n}\n\n# Run\nshinyApp(ui = ui, server = server)\n\n","type":"text"}]
